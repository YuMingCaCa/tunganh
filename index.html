<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Quản lý Cửa hàng Lợn đất Tùng Anh</title>
    <!-- Tải Tailwind CSS để làm đẹp giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện icon Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải thư viện Chart.js để vẽ biểu đồ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS bổ sung để giao diện mượt mà hơn */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Thêm font Inter từ Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal { backdrop-filter: blur(5px); }
        /* Style cho date picker */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-900 text-white">

    <!-- Modal để nhập Mã Cửa Hàng -->
    <div id="store-id-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-white mb-4">Chào mừng!</h2>
            <p class="text-slate-300 mb-2">Để bắt đầu, hãy đặt tên cho cửa hàng của bạn.</p>
            <p class="text-slate-400 text-sm mb-6">Nếu bạn đã có cửa hàng, chỉ cần nhập lại đúng tên đó để truy cập.</p>
            <input type="text" id="store-id-input" placeholder="ví dụ: Cua Hang Heo Dat A Tuan" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
            <button id="use-store-id-btn" class="mt-4 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Truy Cập / Tạo Mới</button>
        </div>
    </div>
    
    <!-- Modal để Sửa tên sản phẩm -->
    <div id="edit-product-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-white mb-4">Sửa Tên Sản Phẩm</h2>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id">
                <input type="text" id="edit-product-name" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                <p id="edit-product-feedback" class="text-sm mt-2 h-5"></p>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Hủy</button>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal để Sửa lô hàng nhập -->
    <div id="edit-inventory-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-white mb-4">Sửa Chi Tiết Lô Hàng</h2>
            <form id="edit-inventory-form">
                <input type="hidden" id="edit-inventory-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-inventory-quantity" class="text-sm text-slate-400">Số lượng nhập ban đầu</label>
                        <input type="number" id="edit-inventory-quantity" min="1" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label for="edit-inventory-price" class="text-sm text-slate-400">Giá nhập / SP</label>
                        <input type="number" id="edit-inventory-price" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label for="edit-inventory-date" class="text-sm text-slate-400">Ngày nhập</label>
                        <input type="date" id="edit-inventory-date" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                </div>
                <p id="edit-inventory-feedback" class="text-sm mt-2 h-5"></p>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="cancel-edit-inventory-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Hủy</button>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal để Xác nhận Xóa sản phẩm -->
    <div id="delete-product-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-red-500 mb-4">Xác Nhận Xóa Sản Phẩm</h2>
            <p class="text-slate-300 mb-6">Bạn có chắc chắn muốn xóa sản phẩm <strong id="delete-product-name" class="text-white"></strong>? <br><br><span class="text-yellow-400">Cảnh báo: Toàn bộ dữ liệu nhập kho và bán hàng liên quan đến sản phẩm này cũng sẽ bị xóa vĩnh viễn.</span></p>
            <div class="flex gap-4 mt-4">
                <button type="button" id="cancel-delete-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Xóa Vĩnh Viễn</button>
            </div>
        </div>
    </div>

    <!-- Modal để Sửa Đơn Hàng -->
    <div id="edit-sale-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h2 class="text-2xl font-bold text-white mb-4">Sửa Đơn Hàng</h2>
            <form id="edit-sale-form">
                <input type="hidden" id="edit-sale-id">
                <p class="text-slate-300 mb-4">Sản phẩm: <strong id="edit-sale-product-name" class="text-white"></strong></p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="edit-sale-quantity" class="text-sm text-slate-400">Số lượng</label>
                        <input type="number" id="edit-sale-quantity" min="1" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label for="edit-sale-price" class="text-sm text-slate-400">Giá bán / SP</label>
                        <input type="number" id="edit-sale-price" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label for="edit-sale-date" class="text-sm text-slate-400">Ngày bán</label>
                        <input type="date" id="edit-sale-date" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>
                </div>
                <p id="edit-sale-feedback" class="text-sm mt-2 h-5"></p>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="cancel-edit-sale-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Hủy</button>
                    <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal để Xác nhận Xóa Đơn Hàng -->
    <div id="delete-sale-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-red-500 mb-4">Xác Nhận Xóa Đơn Hàng</h2>
            <p class="text-slate-300 mb-6">Bạn có chắc chắn muốn xóa đơn hàng này? <br><br><span class="text-yellow-400">Hành động này sẽ hoàn trả lại số lượng hàng đã bán vào kho.</span></p>
            <div class="flex gap-4 mt-4">
                <button type="button" id="cancel-delete-sale-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Hủy</button>
                <button type="button" id="confirm-delete-sale-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Xóa Đơn Hàng</button>
            </div>
        </div>
    </div>


    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-white">Trình Quản lý Cửa hàng Lợn đất Tùng Anh</h1>
                <p class="text-slate-400 mt-2">An Khang Thịnh Vượng - Vạn Sự Như Ý - Tiền vào như nước sông Đà - Tiền ra nhỏ giọt như cà phê đen</p>
                <div id="store-id-display-container" class="mt-4 flex items-center bg-slate-800/50 text-slate-300 text-xs p-2 rounded-lg max-w-max hidden">
                    <i data-lucide="store" class="w-4 h-4 mr-2 text-cyan-400"></i>
                    <span class="mr-1">Mã Cửa Hàng:</span>
                    <span class="font-mono" id="store-id-display"></span>
                </div>
            </header>

            <!-- Loading Spinner -->
            <div id="loader" class="flex items-center justify-center h-64">
                <div class="text-center">
                    <svg class="animate-spin h-10 w-10 text-cyan-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-lg">Đang chờ Mã Cửa Hàng...</p>
                </div>
            </div>

            <!-- Main Content (hidden until loaded) -->
            <main id="main-content" class="hidden">
                <!-- Bảng điều khiển thống kê -->
                <div class="flex justify-end items-center gap-4 mb-4">
                    <label for="stats-month-picker" class="text-sm text-slate-400 whitespace-nowrap">Thống kê tháng:</label>
                    <input type="month" id="stats-month-picker" class="bg-slate-700 text-white p-2 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button id="stats-all-time-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Xem Toàn Thời Gian</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg"><p class="text-lg font-medium text-slate-400">Tổng Doanh thu</p><h3 id="stats-revenue" class="text-3xl font-bold text-white mt-2">0 ₫</h3></div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg"><p class="text-lg font-medium text-slate-400">Lợi nhuận Gộp</p><h3 id="stats-profit" class="text-3xl font-bold text-white mt-2">0 ₫</h3></div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg"><p id="net-profit-label" class="text-lg font-medium text-slate-400">Lợi nhuận Ròng (Ước tính)</p><h3 id="stats-net-profit" class="text-3xl font-bold text-white mt-2">0 ₫</h3></div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg"><p class="text-lg font-medium text-slate-400">Giá trị Tồn kho</p><h3 id="stats-inventory-value" class="text-3xl font-bold text-white mt-2">0 ₫</h3></div>
                </div>

                <!-- Khu vực Menu và Nội dung -->
                <div class="bg-slate-800 rounded-xl shadow-lg mb-8">
                    <!-- Menu Tabs -->
                    <div id="main-tabs" class="flex border-b border-slate-700 px-2 flex-wrap">
                        <button data-tab="sales" class="tab-btn flex items-center gap-2 py-4 px-4 text-sm font-medium border-b-2 transition-colors">
                            <i data-lucide="shopping-cart" class="w-5 h-5"></i> Bán Hàng
                        </button>
                        <button data-tab="inventory" class="tab-btn flex items-center gap-2 py-4 px-4 text-sm font-medium border-b-2 transition-colors">
                            <i data-lucide="inbox" class="w-5 h-5"></i> Nhập Kho
                        </button>
                        <button data-tab="products" class="tab-btn flex items-center gap-2 py-4 px-4 text-sm font-medium border-b-2 transition-colors">
                            <i data-lucide="package" class="w-5 h-5"></i> Sản Phẩm
                        </button>
                         <button data-tab="reports" class="tab-btn flex items-center gap-2 py-4 px-4 text-sm font-medium border-b-2 transition-colors">
                            <i data-lucide="bar-chart-3" class="w-5 h-5"></i> Báo cáo
                        </button>
                        <button data-tab="settings" class="tab-btn flex items-center gap-2 py-4 px-4 text-sm font-medium border-b-2 transition-colors">
                            <i data-lucide="settings" class="w-5 h-5"></i> Thiết Lập
                        </button>
                    </div>
                    <!-- Nội dung Tabs -->
                    <div id="tab-content" class="p-6">
                        <!-- Bán Hàng -->
                        <div id="sales-tab" class="tab-pane">
                             <form id="add-sale-form">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="md:col-span-1">
                                         <label for="sale-product-select" class="text-sm text-slate-400">Sản phẩm</label>
                                        <select id="sale-product-select" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></select>
                                    </div>
                                    <div class="md:col-span-3 grid grid-cols-3 gap-4">
                                        <div>
                                            <label for="sale-quantity" class="text-sm text-slate-400">Số lượng (Tồn: <span id="sale-available-stock" class="font-bold text-white">0</span>)</label>
                                            <input type="number" id="sale-quantity" placeholder="Số lượng" min="1" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                        </div>
                                         <div>
                                            <label for="sale-price" class="text-sm text-slate-400">Giá bán / SP</label>
                                            <input type="number" id="sale-price" placeholder="Giá bán" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                        </div>
                                        <div>
                                            <label for="sale-date" class="text-sm text-slate-400">Ngày bán</label>
                                            <input type="date" id="sale-date" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                        </div>
                                    </div>
                                </div>
                                <div id="sale-suggestion-container" class="mt-2 text-center text-sm text-slate-300">
                                    <span class="mr-4">Bình quân giá nhập: <strong id="average-cost-display" class="text-amber-400">---</strong></span>
                                    <span>Giá gợi ý / SP: <strong id="suggested-price" class="text-cyan-400">---</strong></span>
                                </div>
                                <div id="sale-out-of-stock-msg" class="mt-2 text-center text-sm text-red-500 font-bold hidden">
                                    Sản phẩm này đã hết hàng!
                                </div>
                                <button type="submit" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center disabled:bg-slate-500">
                                    <i data-lucide="dollar-sign" class="w-5 h-5 mr-2"></i>Tạo Đơn Hàng
                                </button>
                                <p id="sale-feedback" class="text-sm mt-2 h-5"></p>
                            </form>
                        </div>
                        <!-- Nhập Kho -->
                        <div id="inventory-tab" class="tab-pane hidden">
                            <form id="add-inventory-form">
                                <select id="inventory-product-select" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 mb-4 focus:ring-2 focus:ring-cyan-500 focus:outline-none"></select>
                                <input type="number" id="inventory-quantity" placeholder="Số lượng nhập" min="1" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 mb-4 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="inventory-price" class="text-sm text-slate-400">Giá nhập / SP</label>
                                        <input type="number" id="inventory-price" placeholder="Giá nhập" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                    </div>
                                    <div>
                                        <label for="inventory-date" class="text-sm text-slate-400">Ngày nhập</label>
                                        <input type="date" id="inventory-date" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center disabled:bg-slate-500">
                                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Nhập Kho
                                </button>
                                <p id="inventory-warning" class="text-yellow-400 text-sm mt-2 hidden">Vui lòng thêm sản phẩm trước khi nhập kho.</p>
                            </form>
                        </div>
                        <!-- Sản Phẩm -->
                        <div id="products-tab" class="tab-pane hidden">
                             <form id="add-product-form" class="flex items-center gap-4 mb-4">
                                <input type="text" id="product-name" placeholder="Nhập tên sản phẩm mới..." class="flex-grow w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center disabled:bg-slate-500">
                                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Thêm
                                </button>
                            </form>
                            <p id="product-feedback" class="text-sm -mt-2 mb-4 h-5"></p>
                            <div id="product-list-container" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Danh sách sản phẩm sẽ được chèn vào đây -->
                            </div>
                        </div>
                        <!-- Báo cáo -->
                        <div id="reports-tab" class="tab-pane hidden">
                            <div class="flex flex-wrap items-center gap-4 mb-6">
                                <div class="flex-grow">
                                    <label class="text-sm text-slate-400">Lọc theo khoảng ngày</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="date" id="report-start-date" class="bg-slate-700 text-white p-2 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                        <span>-</span>
                                        <input type="date" id="report-end-date" class="bg-slate-700 text-white p-2 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                    </div>
                                </div>
                                <div id="month-filter-container" class="flex gap-2 flex-wrap">
                                    <!-- Nút lọc theo tháng sẽ được chèn vào đây -->
                                </div>
                                <button id="export-report-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3 rounded-lg transition-colors flex items-center gap-2">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Xuất Báo cáo
                                </button>
                            </div>
                             <div class="bg-slate-700/50 p-4 rounded-lg mb-6 text-center">
                                <span class="text-slate-400">Tổng lợi nhuận trong khoảng thời gian đã chọn:</span>
                                <strong id="filtered-profit-display" class="text-2xl ml-2 text-green-400">0 ₫</strong>
                            </div>
                            <div class="bg-slate-700/50 p-4 rounded-lg mb-6">
                                <canvas id="sales-chart"></canvas>
                            </div>
                            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                                <div class="xl:col-span-2 max-h-[600px] overflow-y-auto">
                                    <h4 class="font-semibold text-lg text-white mb-3">Lịch sử Bán hàng (Chi tiết)</h4>
                                    <table class="w-full text-left text-sm">
                                        <thead class="text-slate-400 sticky top-0 bg-slate-800">
                                            <tr>
                                                <th class="p-2 font-normal">Ngày bán</th>
                                                <th class="p-2 font-normal">Sản phẩm</th>
                                                <th class="p-2 font-normal text-right">SL</th>
                                                <th class="p-2 font-normal text-right">Giá vốn/SP</th>
                                                <th class="p-2 font-normal text-right">Giá bán/SP</th>
                                                <th class="p-2 font-normal text-right">Lợi nhuận</th>
                                                <th class="p-2 font-normal text-center">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sales-details-container">
                                            <!-- Dữ liệu bán hàng sẽ được chèn vào đây -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="bg-slate-700/50 p-4 rounded-lg xl:col-span-1">
                                    <h4 class="font-semibold text-lg text-white mb-3 text-center">Lợi nhuận theo ngày</h4>
                                    <div class="max-h-[550px] overflow-y-auto">
                                        <table class="w-full text-left text-sm">
                                            <thead class="text-slate-400 sticky top-0 bg-slate-700/50">
                                                 <tr>
                                                    <th class="p-2 font-normal">Ngày</th>
                                                    <th class="p-2 font-normal text-right">Tổng Lợi nhuận</th>
                                                </tr>
                                            </thead>
                                            <tbody id="daily-profit-container">
                                                <!-- Dữ liệu lợi nhuận ngày sẽ được chèn vào đây -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Thiết Lập -->
                        <div id="settings-tab" class="tab-pane hidden">
                            <form id="settings-form" class="space-y-4 max-w-lg mx-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="setting-fixed-cost" class="text-sm text-slate-400">Chi phí cố định / tháng</label>
                                        <input type="number" id="setting-fixed-cost" placeholder="VD: 10,000,000" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label for="setting-profit-margin" class="text-sm text-slate-400">Lợi nhuận mong muốn (%)</label>
                                        <input type="number" id="setting-profit-margin" placeholder="VD: 30" min="0" class="w-full mt-1 bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Lưu Thiết Lập</button>
                                <p id="settings-feedback" class="text-sm text-center h-5"></p>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Chi tiết Tồn kho -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-lg col-span-1 lg:col-span-2">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center"><i data-lucide="archive" class="w-5 h-5 mr-2"></i>Chi tiết Tồn kho</h3>
                    <div id="inventory-details-container" class="space-y-6 max-h-[600px] overflow-y-auto">
                        <!-- Dữ liệu sẽ được chèn vào đây bởi JavaScript -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase và Logic của ứng dụng -->
    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            writeBatch,
            doc,
            Timestamp,
            where,
            getDocs,
            updateDoc,
            deleteDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
        // =================================================================================
        // == CẤU HÌNH FIREBASE CỦA BẠN ĐÃ ĐƯỢC THÊM VÀO ĐÂY ==
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDosCykP-rrTVAlwfAOXDGgGioxtt-VrOs",
            authDomain: "quanlykinhdoanh-cb2b1.firebaseapp.com",
            projectId: "quanlykinhdoanh-cb2b1",
            storageBucket: "quanlykinhdoanh-cb2b1.appspot.com",
            messagingSenderId: "478736931655",
            appId: "1:478736931655:web:b216ac919d9aeca334ca62"
        };
        // =================================================================================

        if (!firebaseConfig.apiKey) {
            document.getElementById('loader').innerHTML = `<div class="text-center text-yellow-400 bg-yellow-900/50 p-6 rounded-lg"><h2 class="text-2xl font-bold mb-2">Chưa có Cấu hình Firebase!</h2><p>Vui lòng mở file HTML này, tìm đến phần JavaScript và dán đối tượng 'firebaseConfig' của bạn vào.</p></div>`;
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let storeId = null;
            let products = [];
            let inventory = [];
            let sales = [];
            let businessConfig = { fixedCost: 0, profitMargin: 20 };
            let unsubscribeProducts, unsubscribeInventory, unsubscribeSales, unsubscribeConfig;
            let salesChart = null;
            let statsFilterValue = 'all'; // Biến trạng thái cho bộ lọc thống kê

            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const storeIdModal = document.getElementById('store-id-modal');
            const editProductModal = document.getElementById('edit-product-modal');
            const deleteProductModal = document.getElementById('delete-product-modal');
            const editInventoryModal = document.getElementById('edit-inventory-modal');
            const editSaleModal = document.getElementById('edit-sale-modal');
            const deleteSaleModal = document.getElementById('delete-sale-modal');

            const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
            const formatDate = (timestamp) => timestamp ? new Date(timestamp.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
            const dateToIso = (date) => date.toISOString().split('T')[0];
            
            function setDefaultDates() {
                const today = dateToIso(new Date());
                document.getElementById('inventory-date').value = today;
                document.getElementById('sale-date').value = today;
                document.getElementById('report-end-date').value = today;
                const startOfMonth = new Date(new Date().setDate(1));
                document.getElementById('report-start-date').value = dateToIso(startOfMonth);
            }

            function updateStats() {
                const filter = statsFilterValue; // Sử dụng biến trạng thái
                let filteredSales = sales;

                if (filter !== 'all' && filter) {
                    const [year, month] = filter.split('-').map(Number);
                    const startDate = new Date(year, month - 1, 1);
                    const endDate = new Date(year, month, 0);
                    endDate.setHours(23, 59, 59, 999);
                    filteredSales = sales.filter(s => {
                        const saleDate = s.saleDate.toDate();
                        return saleDate >= startDate && saleDate <= endDate;
                    });
                }
                
                renderStats(filteredSales, filter);
            }

            function filterAndRenderReports() {
                const startDateInput = document.getElementById('report-start-date').value;
                const endDateInput = document.getElementById('report-end-date').value;
                if (!startDateInput || !endDateInput) return;

                const startDate = new Date(startDateInput);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endDateInput);
                endDate.setHours(23, 59, 59, 999);

                const filteredSales = sales.filter(sale => {
                    const saleDate = sale.saleDate.toDate();
                    return saleDate >= startDate && saleDate <= endDate;
                });
                
                renderSalesDetails(filteredSales);
                renderDailyProfit(filteredSales);
                renderChart(filteredSales);

                const totalProfit = filteredSales.reduce((sum, sale) => sum + sale.profit, 0);
                const filteredProfitEl = document.getElementById('filtered-profit-display');
                filteredProfitEl.textContent = formatCurrency(totalProfit);
                filteredProfitEl.classList.toggle('text-red-400', totalProfit < 0);
                filteredProfitEl.classList.toggle('text-green-400', totalProfit >= 0);
            }

            function renderAll() {
                renderProductList();
                renderProductSelects();
                renderInventoryDetails();
                filterAndRenderReports(); 
                updateStats();
                updateSaleFormAvailability();
            }
            
            function renderProductList() {
                const container = document.getElementById('product-list-container');
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-slate-400 text-center py-4">Chưa có sản phẩm nào.</p>';
                } else {
                    products.forEach(p => {
                        const productEl = document.createElement('div');
                        productEl.className = 'flex items-center justify-between bg-slate-700/50 p-3 rounded-lg';
                        productEl.innerHTML = `
                            <span class="font-medium text-white">${p.name}</span>
                            <div class="flex gap-2">
                                <button data-product-id="${p.id}" data-product-name="${p.name}" class="edit-btn p-2 text-slate-400 hover:text-cyan-400 transition-colors"><i data-lucide="file-pen-line" class="w-5 h-5"></i></button>
                                <button data-product-id="${p.id}" data-product-name="${p.name}" class="delete-btn p-2 text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        `;
                        container.appendChild(productEl);
                    });
                }
                lucide.createIcons();
            }

            function renderProductSelects() {
                const inventorySelect = document.getElementById('inventory-product-select');
                const saleSelect = document.getElementById('sale-product-select');
                const currentInventoryVal = inventorySelect.value;
                const currentSaleVal = saleSelect.value;
                inventorySelect.innerHTML = '';
                saleSelect.innerHTML = '';

                if (products.length === 0) {
                    inventorySelect.innerHTML = '<option>Chưa có sản phẩm</option>';
                    saleSelect.innerHTML = '<option>Chưa có sản phẩm</option>';
                    document.getElementById('inventory-warning').classList.remove('hidden');
                } else {
                    document.getElementById('inventory-warning').classList.add('hidden');
                    products.forEach(p => {
                        const option = `<option value="${p.id}">${p.name}</option>`;
                        inventorySelect.innerHTML += option;
                        saleSelect.innerHTML += option;
                    });
                    inventorySelect.value = currentInventoryVal || (products[0]?.id || '');
                    saleSelect.value = currentSaleVal || (products[0]?.id || '');
                }
                updateSaleFormAvailability();
            }
            
            function renderInventoryDetails() {
                const container = document.getElementById('inventory-details-container');
                container.innerHTML = '';
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-slate-400 text-center py-4">Chưa có dữ liệu tồn kho.</p>';
                    return;
                }
                
                products.forEach(product => {
                    const productBatches = inventory.filter(item => item.productId === product.id && item.remainingQuantity >= 0); // Show even if 0
                    const totalStock = productBatches.reduce((sum, item) => sum + item.remainingQuantity, 0);

                    const productDiv = document.createElement('div');
                    productDiv.className = 'bg-slate-700/50 p-4 rounded-lg';
                    
                    let tableRows = '';
                    productBatches
                        .sort((a,b) => a.purchaseDate.seconds - b.purchaseDate.seconds) // FIFO display
                        .forEach(batch => {
                        tableRows += `
                            <tr class="border-b border-slate-600/50 last:border-0 hover:bg-slate-600/30">
                                <td class="p-2 text-slate-300">${formatDate(batch.purchaseDate)}</td>
                                <td class="p-2 text-right font-mono">${batch.initialQuantity}</td>
                                <td class="p-2 text-right font-mono text-cyan-400">${batch.remainingQuantity}</td>
                                <td class="p-2 text-right font-mono">${formatCurrency(batch.purchasePrice)}</td>
                                <td class="p-2 text-right">
                                    <button data-batch-id="${batch.id}" class="edit-inventory-btn p-1 text-slate-400 hover:text-cyan-400 transition-colors"><i data-lucide="file-pen-line" class="w-4 h-4"></i></button>
                                </td>
                            </tr>
                        `;
                    });

                    productDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-lg text-white">${product.name}</h4>
                            <span class="text-lg font-bold text-cyan-400">${totalStock} <span class="text-sm font-normal text-slate-400">tồn kho</span></span>
                        </div>
                        ${productBatches.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="text-slate-400">
                                    <tr>
                                        <th class="p-2 font-normal">Ngày nhập</th>
                                        <th class="p-2 font-normal text-right">SL Nhập</th>
                                        <th class="p-2 font-normal text-right">SL Còn</th>
                                        <th class="p-2 font-normal text-right">Giá nhập</th>
                                        <th class="p-2 font-normal text-right">Sửa</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-batches-list-${product.id}">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                        ` : '<p class="text-slate-400 text-center py-2">Chưa có lô hàng nào.</p>'}
                    `;
                    container.appendChild(productDiv);
                });
                lucide.createIcons();
            }
            
            function renderSalesDetails(salesData) {
                const container = document.getElementById('sales-details-container');
                container.innerHTML = '';
                if(salesData.length === 0) {
                    container.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">Không có đơn hàng nào trong khoảng thời gian này.</td></tr>';
                    return;
                }
                
                salesData.sort((a,b) => b.saleDate.seconds - a.saleDate.seconds)
                    .forEach(sale => {
                        const row = document.createElement('tr');
                        row.className = "border-b border-slate-700/50 last:border-0";
                        row.innerHTML = `
                            <td class="p-2 text-slate-300">${formatDate(sale.saleDate)}</td>
                            <td class="p-2">${sale.productName}</td>
                            <td class="p-2 text-right font-mono">${sale.quantitySold}</td>
                            <td class="p-2 text-right font-mono text-amber-400">${formatCurrency(sale.cogsPerItem)}</td>
                            <td class="p-2 text-right font-mono">${formatCurrency(sale.sellingPrice)}</td>
                            <td class="p-2 text-right font-mono ${sale.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(sale.profit)}</td>
                            <td class="p-2 text-center">
                                <div class="flex justify-center gap-2">
                                    <button data-sale-id="${sale.id}" class="edit-sale-btn p-1 text-slate-400 hover:text-cyan-400 transition-colors"><i data-lucide="file-pen-line" class="w-4 h-4"></i></button>
                                    <button data-sale-id="${sale.id}" class="delete-sale-btn p-1 text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </td>
                        `;
                        container.appendChild(row);
                    });
                lucide.createIcons();
            }

            function renderDailyProfit(salesData) {
                const container = document.getElementById('daily-profit-container');
                container.innerHTML = '';
                if(salesData.length === 0) {
                    container.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">...</td></tr>';
                    return;
                }

                const dailyProfits = salesData.reduce((acc, sale) => {
                    const date = formatDate(sale.saleDate);
                    if (!acc[date]) {
                        acc[date] = 0;
                    }
                    acc[date] += sale.profit;
                    return acc;
                }, {});

                Object.entries(dailyProfits)
                    .sort((a,b) => new Date(b[0].split('/').reverse().join('-')) - new Date(a[0].split('/').reverse().join('-')))
                    .forEach(([date, totalProfit]) => {
                        const row = `
                             <tr class="border-b border-slate-600/50 last:border-0">
                                <td class="p-2 text-slate-300">${date}</td>
                                <td class="p-2 text-right font-mono ${totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(totalProfit)}</td>
                            </tr>
                        `;
                        container.innerHTML += row;
                    });
            }

            function renderStats(salesData, filter) {
                const totalRevenue = salesData.reduce((sum, sale) => sum + sale.totalRevenue, 0);
                const grossProfit = salesData.reduce((sum, sale) => sum + sale.profit, 0);
                const totalInventoryValue = inventory.reduce((sum, item) => sum + (item.remainingQuantity * item.purchasePrice), 0);
                
                let estimatedNetProfit = grossProfit;
                const netProfitLabel = document.getElementById('net-profit-label');
                
                if (filter !== 'all' && filter) {
                    estimatedNetProfit -= (businessConfig.fixedCost || 0);
                    netProfitLabel.textContent = 'Lợi nhuận Ròng (Tháng)';
                } else {
                    netProfitLabel.textContent = 'Lợi nhuận Ròng (Toàn TG)';
                }
                
                const netProfitEl = document.getElementById('stats-net-profit');
                if (netProfitEl) {
                    netProfitEl.textContent = formatCurrency(estimatedNetProfit);
                    netProfitEl.classList.toggle('text-red-500', estimatedNetProfit < 0);
                    netProfitEl.classList.toggle('text-white', estimatedNetProfit >= 0);
                }

                const revenueEl = document.getElementById('stats-revenue');
                if (revenueEl) {
                    revenueEl.textContent = formatCurrency(totalRevenue);
                }

                const profitEl = document.getElementById('stats-profit');
                if (profitEl) {
                    profitEl.textContent = formatCurrency(grossProfit);
                }

                const inventoryValueEl = document.getElementById('stats-inventory-value');
                if (inventoryValueEl) {
                    inventoryValueEl.textContent = formatCurrency(totalInventoryValue);
                }
            }

            function updateSaleFormAvailability() {
                const selectedProductId = document.getElementById('sale-product-select').value;
                const availableStock = inventory
                    .filter(item => item.productId === selectedProductId)
                    .reduce((sum, item) => sum + item.remainingQuantity, 0);
                
                const quantityInput = document.getElementById('sale-quantity');
                const priceInput = document.getElementById('sale-price');
                const saleButton = document.querySelector('#add-sale-form button');
                const suggestionContainer = document.getElementById('sale-suggestion-container');
                const outOfStockMsg = document.getElementById('sale-out-of-stock-msg');

                document.getElementById('sale-available-stock').textContent = availableStock;
                quantityInput.max = availableStock;

                if (availableStock === 0 || products.length === 0) {
                    quantityInput.disabled = true;
                    priceInput.disabled = true;
                    saleButton.disabled = true;
                    suggestionContainer.classList.add('hidden');
                    outOfStockMsg.classList.remove('hidden');
                } else {
                    quantityInput.disabled = false;
                    priceInput.disabled = false;
                    saleButton.disabled = false;
                    suggestionContainer.classList.remove('hidden');
                    outOfStockMsg.classList.add('hidden');
                }
                calculateSuggestedPrice();
            }

            // --- LOGIC SỬA, XÓA, THÊM ---
            document.getElementById('add-product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productNameInput = document.getElementById('product-name');
                const feedbackEl = document.getElementById('product-feedback');
                const productName = productNameInput.value.trim();
                
                feedbackEl.textContent = ''; 

                if (!productName || !storeId) return;
                
                const isDuplicate = products.some(p => p.name.toLowerCase() === productName.toLowerCase());

                if (isDuplicate) {
                    feedbackEl.textContent = `Sản phẩm "${productName}" đã tồn tại.`;
                    feedbackEl.className = 'text-yellow-400 text-sm h-5';
                    return; 
                }
                
                const button = e.target.querySelector('button');
                button.disabled = true;
                try {
                    await addDoc(collection(db, `stores/${storeId}/products`), {
                        name: productName,
                        createdAt: Timestamp.now(),
                    });
                    productNameInput.value = '';
                    feedbackEl.textContent = `Đã thêm "${productName}"!`;
                    feedbackEl.className = 'text-green-400 text-sm h-5';
                    setTimeout(() => { feedbackEl.textContent = '' }, 3000);
                } catch (error) {
                    console.error("Lỗi khi thêm sản phẩm:", error);
                    feedbackEl.textContent = 'Lỗi: Không thể thêm sản phẩm.';
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                } finally {
                    button.disabled = false;
                }
            });
            
            // Xử lý click Sửa/Xóa
            document.getElementById('product-list-container').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const productId = editBtn.dataset.productId;
                    const productName = editBtn.dataset.productName;
                    document.getElementById('edit-product-id').value = productId;
                    document.getElementById('edit-product-name').value = productName;
                    document.getElementById('edit-product-feedback').textContent = '';
                    editProductModal.classList.remove('hidden');
                }

                if (deleteBtn) {
                    const productId = deleteBtn.dataset.productId;
                    const productName = deleteBtn.dataset.productName;
                    document.getElementById('delete-product-name').textContent = productName;
                    deleteProductModal.dataset.productId = productId; // Lưu id vào modal
                    deleteProductModal.classList.remove('hidden');
                }
            });

            // Form sửa sản phẩm
            document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('edit-product-id').value;
                const newName = document.getElementById('edit-product-name').value.trim();
                const feedbackEl = document.getElementById('edit-product-feedback');
                feedbackEl.textContent = '';

                if (!newName) return;

                const isDuplicate = products.some(p => p.id !== productId && p.name.toLowerCase() === newName.toLowerCase());
                if (isDuplicate) {
                    feedbackEl.textContent = `Tên "${newName}" đã được sử dụng.`;
                    feedbackEl.className = 'text-yellow-400 text-sm h-5';
                    return;
                }

                try {
                    const productRef = doc(db, `stores/${storeId}/products`, productId);
                    await updateDoc(productRef, { name: newName });
                    editProductModal.classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi sửa sản phẩm:", error);
                    feedbackEl.textContent = 'Lỗi: Không thể lưu thay đổi.';
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                }
            });

            // Nút hủy sửa
            document.getElementById('cancel-edit-btn').addEventListener('click', () => editProductModal.classList.add('hidden'));

            // Nút xác nhận xóa
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                const productId = deleteProductModal.dataset.productId;
                if (!productId) return;

                const batch = writeBatch(db);

                try {
                    const productRef = doc(db, `stores/${storeId}/products`, productId);
                    batch.delete(productRef);

                    const inventoryQuery = query(collection(db, `stores/${storeId}/inventoryBatches`), where("productId", "==", productId));
                    const inventorySnapshot = await getDocs(inventoryQuery);
                    inventorySnapshot.forEach(doc => batch.delete(doc.ref));

                    const salesQuery = query(collection(db, `stores/${storeId}/sales`), where("productId", "==", productId));
                    const salesSnapshot = await getDocs(salesQuery);
                    salesSnapshot.forEach(doc => batch.delete(doc.ref));

                    await batch.commit();
                    deleteProductModal.classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi xóa sản phẩm và dữ liệu liên quan:", error);
                    alert("Đã xảy ra lỗi nghiêm trọng khi xóa sản phẩm. Vui lòng thử lại.");
                }
            });

            // Nút hủy xóa
            document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteProductModal.classList.add('hidden'));


            document.getElementById('add-inventory-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productId = document.getElementById('inventory-product-select').value;
                const quantity = Number(document.getElementById('inventory-quantity').value);
                const price = Number(document.getElementById('inventory-price').value);
                const dateValue = document.getElementById('inventory-date').value;
                const productName = products.find(p => p.id === productId)?.name;

                if (!productId || !productName || !quantity || price < 0 || !dateValue || !storeId) return;

                const button = e.target.querySelector('button');
                button.disabled = true;
                try {
                    await addDoc(collection(db, `stores/${storeId}/inventoryBatches`), {
                        productId: productId,
                        productName: productName,
                        initialQuantity: quantity,
                        remainingQuantity: quantity,
                        purchasePrice: price,
                        purchaseDate: Timestamp.fromDate(new Date(dateValue)),
                    });
                    e.target.reset();
                    setDefaultDates();
                } catch (error) {
                    console.error("Lỗi khi nhập kho:", error);
                    alert("Đã xảy ra lỗi khi nhập kho.");
                } finally {
                    button.disabled = false;
                }
            });

            // Tách logic tạo đơn hàng để tái sử dụng
            async function createSale(saleDetails) {
                const { productId, quantityToSell, sellingPrice, dateValue } = saleDetails;
                
                const productInventoryBatches = inventory.filter(item => item.productId === productId && item.remainingQuantity > 0);
                const totalStock = productInventoryBatches.reduce((sum, batch) => sum + batch.remainingQuantity, 0);
                
                if (totalStock < quantityToSell) {
                    throw new Error(`Không đủ hàng! Chỉ còn ${totalStock} sản phẩm trong kho.`);
                }

                const fifoBatchesForSale = [...productInventoryBatches].sort((a, b) => a.purchaseDate.seconds - b.purchaseDate.seconds);
                let remainingToCalcCost = quantityToSell;
                let actualTotalCostOfGoodsSold = 0;
                for (const invBatch of fifoBatchesForSale) {
                    if (remainingToCalcCost <= 0) break;
                    const qtyFromThisBatch = Math.min(remainingToCalcCost, invBatch.remainingQuantity);
                    actualTotalCostOfGoodsSold += qtyFromThisBatch * invBatch.purchasePrice;
                    remainingToCalcCost -= qtyFromThisBatch;
                }
                const actualCogsPerItem = actualTotalCostOfGoodsSold / quantityToSell;

                const batch = writeBatch(db);
                let remainingToSell = quantityToSell;
                for (const invBatch of fifoBatchesForSale) {
                    if (remainingToSell <= 0) break;
                    const quantityFromThisBatch = Math.min(remainingToSell, invBatch.remainingQuantity);
                    const newRemainingQuantity = invBatch.remainingQuantity - quantityFromThisBatch;
                    const batchDocRef = doc(db, `stores/${storeId}/inventoryBatches`, invBatch.id);
                    batch.update(batchDocRef, { remainingQuantity: newRemainingQuantity });
                    remainingToSell -= quantityFromThisBatch;
                }

                const totalRevenue = quantityToSell * sellingPrice;
                const profit = totalRevenue - actualTotalCostOfGoodsSold;
                const newSaleRef = doc(collection(db, `stores/${storeId}/sales`));

                batch.set(newSaleRef, {
                    productId: productId,
                    productName: products.find(p => p.id === productId)?.name,
                    quantitySold: quantityToSell,
                    sellingPrice: sellingPrice,
                    totalRevenue: totalRevenue,
                    totalCostOfGoodsSold: actualTotalCostOfGoodsSold,
                    cogsPerItem: actualCogsPerItem,
                    profit: profit,
                    saleDate: Timestamp.fromDate(new Date(dateValue)),
                });

                return batch.commit();
            }

            document.getElementById('add-sale-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const feedbackEl = document.getElementById('sale-feedback');
                feedbackEl.textContent = '';
                
                const saleDetails = {
                    productId: document.getElementById('sale-product-select').value,
                    quantityToSell: Number(document.getElementById('sale-quantity').value),
                    sellingPrice: Number(document.getElementById('sale-price').value),
                    dateValue: document.getElementById('sale-date').value
                };

                if (!saleDetails.productId || !saleDetails.quantityToSell || saleDetails.sellingPrice < 0 || !saleDetails.dateValue || !storeId) return;

                const button = e.target.querySelector('button');
                button.disabled = true;
                
                try {
                    await createSale(saleDetails);
                    feedbackEl.textContent = `Bán thành công!`;
                    feedbackEl.className = 'text-green-400 text-sm mt-2 h-5';
                    e.target.reset();
                    setDefaultDates();
                    setTimeout(() => { feedbackEl.textContent = '' }, 3000);
                } catch (error) {
                    console.error("Lỗi khi bán hàng:", error);
                    feedbackEl.textContent = `Lỗi: ${error.message}`;
                    feedbackEl.className = 'text-red-400 text-sm mt-2 h-5';
                } finally {
                    button.disabled = false;
                    updateSaleFormAvailability();
                }
            });

            // --- THIẾT LẬP & GỢI Ý GIÁ ---
            document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const feedbackEl = document.getElementById('settings-feedback');
                const newConfig = {
                    fixedCost: Number(document.getElementById('setting-fixed-cost').value) || 0,
                    profitMargin: Number(document.getElementById('setting-profit-margin').value) || 0,
                };
                
                try {
                    const configRef = doc(db, `stores/${storeId}/config/business`);
                    await setDoc(configRef, newConfig);
                    feedbackEl.textContent = 'Đã lưu thiết lập!';
                    feedbackEl.className = 'text-green-400 text-sm text-center h-5';
                    setTimeout(() => { feedbackEl.textContent = '' }, 3000);
                } catch (error) {
                    console.error("Lỗi khi lưu thiết lập:", error);
                    feedbackEl.textContent = 'Lỗi: Không thể lưu.';
                    feedbackEl.className = 'text-red-400 text-sm text-center h-5';
                }
            });

            function calculateSuggestedPrice() {
                const productId = document.getElementById('sale-product-select').value;
                const suggestedPriceEl = document.getElementById('suggested-price');
                const averageCostEl = document.getElementById('average-cost-display');

                if (!productId) {
                    suggestedPriceEl.textContent = '---';
                    averageCostEl.textContent = '---';
                    return;
                }

                // Tính giá vốn bình quân
                const productInventoryBatches = inventory.filter(item => item.productId === productId && item.remainingQuantity > 0);
                
                const totalValue = productInventoryBatches.reduce((sum, batch) => sum + (batch.remainingQuantity * batch.purchasePrice), 0);
                const totalQuantity = productInventoryBatches.reduce((sum, batch) => sum + batch.remainingQuantity, 0);

                if (totalQuantity === 0) {
                    // Handled by updateSaleFormAvailability
                    return;
                }

                const averageCost = totalValue / totalQuantity;
                averageCostEl.textContent = formatCurrency(averageCost);
                
                // Tính giá bán gợi ý với lợi nhuận
                const suggestedPrice = averageCost * (1 + ((businessConfig.profitMargin || 0) / 100));
                
                suggestedPriceEl.textContent = formatCurrency(suggestedPrice);
            }

            document.getElementById('sale-product-select').addEventListener('change', updateSaleFormAvailability);

            function initializeTabs() {
                const tabsContainer = document.getElementById('main-tabs');
                const tabPanes = document.querySelectorAll('#tab-content .tab-pane');
                const tabBtns = document.querySelectorAll('#main-tabs .tab-btn');

                // Set default tab
                const defaultTab = 'sales';
                const defaultBtn = document.querySelector(`.tab-btn[data-tab="${defaultTab}"]`);
                if (defaultBtn) {
                    defaultBtn.classList.add('text-white', 'border-cyan-500');
                    defaultBtn.classList.remove('text-slate-400', 'border-transparent');
                }
                const defaultPane = document.getElementById(`${defaultTab}-tab`);
                if (defaultPane) {
                    defaultPane.classList.remove('hidden');
                }


                tabsContainer.addEventListener('click', (e) => {
                    const clickedBtn = e.target.closest('.tab-btn');
                    if (!clickedBtn) return;

                    const tabId = clickedBtn.dataset.tab;

                    if (tabId === 'sales' || tabId === 'inventory') {
                        setDefaultDates();
                    }

                    // Update buttons
                    tabBtns.forEach(btn => {
                        btn.classList.remove('text-white', 'border-cyan-500');
                        btn.classList.add('text-slate-400', 'border-transparent');
                    });
                    clickedBtn.classList.add('text-white', 'border-cyan-500');
                    clickedBtn.classList.remove('text-slate-400', 'border-transparent');

                    // Update panes
                    tabPanes.forEach(pane => {
                        if (pane.id === `${tabId}-tab`) {
                            pane.classList.remove('hidden');
                        } else {
                            pane.classList.add('hidden');
                        }
                    });
                });
            }

            function initializeReportFilters() {
                document.getElementById('report-start-date').addEventListener('change', filterAndRenderReports);
                document.getElementById('report-end-date').addEventListener('change', filterAndRenderReports);
                document.getElementById('export-report-btn').addEventListener('click', exportReport);
            }
            
            function renderChart(salesData) {
                const ctx = document.getElementById('sales-chart').getContext('2d');
                
                const dailyData = salesData.reduce((acc, sale) => {
                    const date = formatDate(sale.saleDate);
                    if (!acc[date]) {
                        acc[date] = { revenue: 0, cost: 0, profit: 0 };
                    }
                    acc[date].revenue += sale.totalRevenue;
                    acc[date].cost += sale.totalCostOfGoodsSold;
                    acc[date].profit += sale.profit;
                    return acc;
                }, {});

                const sortedLabels = Object.keys(dailyData).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
                
                const revenueData = sortedLabels.map(label => dailyData[label].revenue);
                const costData = sortedLabels.map(label => dailyData[label].cost);
                const profitData = sortedLabels.map(label => dailyData[label].profit);

                if (salesChart) {
                    salesChart.destroy();
                }

                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedLabels,
                        datasets: [
                            {
                                label: 'Doanh thu',
                                data: revenueData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                tension: 0.1
                            },
                            {
                                label: 'Giá vốn',
                                data: costData,
                                borderColor: 'rgb(245, 158, 11)',
                                backgroundColor: 'rgba(245, 158, 11, 0.5)',
                                tension: 0.1
                            },
                             {
                                label: 'Lợi nhuận',
                                data: profitData,
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.5)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#cbd5e1'
                                }
                            },
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: function(value, index, ticks) {
                                        return formatCurrency(value);
                                    }
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }

            // Mở modal sửa lô hàng
            document.getElementById('inventory-details-container').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-inventory-btn');
                if (editBtn) {
                    const batchId = editBtn.dataset.batchId;
                    const batch = inventory.find(b => b.id === batchId);
                    if (batch) {
                        document.getElementById('edit-inventory-id').value = batch.id;
                        document.getElementById('edit-inventory-quantity').value = batch.initialQuantity;
                        document.getElementById('edit-inventory-price').value = batch.purchasePrice;
                        document.getElementById('edit-inventory-date').value = dateToIso(batch.purchaseDate.toDate());
                        document.getElementById('edit-inventory-feedback').textContent = '';
                        editInventoryModal.classList.remove('hidden');
                    }
                }
            });

            // Form sửa lô hàng
            document.getElementById('edit-inventory-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const batchId = document.getElementById('edit-inventory-id').value;
                const newInitialQuantity = Number(document.getElementById('edit-inventory-quantity').value);
                const newPrice = Number(document.getElementById('edit-inventory-price').value);
                const newDate = new Date(document.getElementById('edit-inventory-date').value);
                const feedbackEl = document.getElementById('edit-inventory-feedback');
                feedbackEl.textContent = '';

                const originalBatch = inventory.find(b => b.id === batchId);
                const soldQuantity = originalBatch.initialQuantity - originalBatch.remainingQuantity;

                if (newInitialQuantity < soldQuantity) {
                    feedbackEl.textContent = `Lỗi: SL nhập mới (${newInitialQuantity}) không thể nhỏ hơn SL đã bán (${soldQuantity}).`;
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                    return;
                }

                const newRemainingQuantity = newInitialQuantity - soldQuantity;

                try {
                    const batchRef = doc(db, `stores/${storeId}/inventoryBatches`, batchId);
                    await updateDoc(batchRef, {
                        initialQuantity: newInitialQuantity,
                        remainingQuantity: newRemainingQuantity,
                        purchasePrice: newPrice,
                        purchaseDate: Timestamp.fromDate(newDate)
                    });
                    editInventoryModal.classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi sửa lô hàng:", error);
                    feedbackEl.textContent = 'Lỗi: Không thể lưu thay đổi.';
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                }
            });
            
            // Nút hủy sửa lô hàng
            document.getElementById('cancel-edit-inventory-btn').addEventListener('click', () => editInventoryModal.classList.add('hidden'));

            function exportReport() {
                const startDateInput = document.getElementById('report-start-date').value;
                const endDateInput = document.getElementById('report-end-date').value;
                 if (!startDateInput || !endDateInput) return;

                const startDate = new Date(startDateInput);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(endDateInput);
                endDate.setHours(23, 59, 59, 999);

                const filteredSales = sales.filter(sale => {
                    const saleDate = sale.saleDate.toDate();
                    return saleDate >= startDate && saleDate <= endDate;
                });
                
                const totalProfit = filteredSales.reduce((sum, sale) => sum + sale.profit, 0);

                const reportWindow = window.open('', '_blank');
                reportWindow.document.write('<html><head><title>Báo cáo Bán hàng</title>');
                reportWindow.document.write('<style>body{font-family:sans-serif;margin:2em} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:8px} th{background-color:#f2f2f2} h1,h2,h3{text-align:center}</style>');
                reportWindow.document.write('</head><body>');
                reportWindow.document.write(`<h1>Báo cáo Bán hàng</h1>`);
                reportWindow.document.write(`<h2>Từ ${formatDate(Timestamp.fromDate(startDate))} đến ${formatDate(Timestamp.fromDate(endDate))}</h2>`);
                reportWindow.document.write(`<h3>Tổng lợi nhuận trong kỳ: ${formatCurrency(totalProfit)}</h3>`);
                
                // Sales Details Table
                reportWindow.document.write('<h4>Chi tiết bán hàng</h4>');
                let salesTable = '<table><thead><tr><th>Ngày bán</th><th>Sản phẩm</th><th>SL</th><th>Giá vốn/SP</th><th>Giá bán/SP</th><th>Lợi nhuận</th></tr></thead><tbody>';
                filteredSales.forEach(sale => {
                    salesTable += `<tr>
                        <td>${formatDate(sale.saleDate)}</td>
                        <td>${sale.productName}</td>
                        <td style="text-align:right">${sale.quantitySold}</td>
                        <td style="text-align:right">${formatCurrency(sale.cogsPerItem)}</td>
                        <td style="text-align:right">${formatCurrency(sale.sellingPrice)}</td>
                        <td style="text-align:right">${formatCurrency(sale.profit)}</td>
                    </tr>`;
                });
                salesTable += '</tbody></table>';
                reportWindow.document.write(salesTable);

                // Daily Profit Table
                reportWindow.document.write('<h4>Lợi nhuận theo ngày</h4>');
                const dailyProfits = filteredSales.reduce((acc, sale) => {
                    const date = formatDate(sale.saleDate);
                    if (!acc[date]) acc[date] = 0;
                    acc[date] += sale.profit;
                    return acc;
                }, {});
                let profitTable = '<table><thead><tr><th>Ngày</th><th>Tổng Lợi nhuận</th></tr></thead><tbody>';
                 Object.entries(dailyProfits).sort((a,b) => new Date(b[0].split('/').reverse().join('-')) - new Date(a[0].split('/').reverse().join('-')))
                    .forEach(([date, totalProfit]) => {
                    profitTable += `<tr><td>${date}</td><td style="text-align:right">${formatCurrency(totalProfit)}</td></tr>`;
                });
                profitTable += '</tbody></table>';
                reportWindow.document.write(profitTable);

                reportWindow.document.write('</body></html>');
                reportWindow.document.close();
            }

            // =================================================================
            // == [MỚI] LOGIC SỬA/XÓA ĐƠN HÀNG
            // =================================================================

            // Tách logic xóa đơn hàng để tái sử dụng
            async function deleteSale(saleId) {
                const saleToDelete = sales.find(s => s.id === saleId);
                if (!saleToDelete) {
                    throw new Error("Không tìm thấy đơn hàng để xóa.");
                }

                const batch = writeBatch(db);

                // Hoàn trả số lượng vào kho
                let quantityToReturn = saleToDelete.quantitySold;
                const relatedBatches = inventory
                    .filter(b => b.productId === saleToDelete.productId)
                    .sort((a, b) => b.purchaseDate.seconds - a.purchaseDate.seconds); // Ưu tiên hoàn trả vào lô mới nhất

                for (const invBatch of relatedBatches) {
                    if (quantityToReturn <= 0) break;
                    
                    const spaceAvailable = invBatch.initialQuantity - invBatch.remainingQuantity;
                    const quantityToRestore = Math.min(quantityToReturn, spaceAvailable);
                    
                    if (quantityToRestore > 0) {
                        const batchDocRef = doc(db, `stores/${storeId}/inventoryBatches`, invBatch.id);
                        batch.update(batchDocRef, { remainingQuantity: invBatch.remainingQuantity + quantityToRestore });
                        quantityToReturn -= quantityToRestore;
                    }
                }

                if (quantityToReturn > 0) {
                    // Trường hợp này hiếm khi xảy ra nếu dữ liệu nhất quán
                    // nhưng nó xử lý trường hợp không có đủ chỗ trống trong các lô hiện có
                    console.warn(`Không thể hoàn trả đủ ${quantityToReturn} sản phẩm vào kho. Có thể do lô hàng đã bị thay đổi.`);
                }

                // Xóa đơn hàng
                const saleRef = doc(db, `stores/${storeId}/sales`, saleId);
                batch.delete(saleRef);

                return batch.commit();
            }

            // Sự kiện click trên bảng Lịch sử bán hàng
            document.getElementById('reports-tab').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-sale-btn');
                const deleteBtn = e.target.closest('.delete-sale-btn');

                if (editBtn) {
                    const saleId = editBtn.dataset.saleId;
                    const sale = sales.find(s => s.id === saleId);
                    if (sale) {
                        document.getElementById('edit-sale-id').value = sale.id;
                        document.getElementById('edit-sale-product-name').textContent = sale.productName;
                        document.getElementById('edit-sale-quantity').value = sale.quantitySold;
                        document.getElementById('edit-sale-price').value = sale.sellingPrice;
                        document.getElementById('edit-sale-date').value = dateToIso(sale.saleDate.toDate());
                        document.getElementById('edit-sale-feedback').textContent = '';
                        editSaleModal.classList.remove('hidden');
                    }
                }

                if (deleteBtn) {
                    const saleId = deleteBtn.dataset.saleId;
                    deleteSaleModal.dataset.saleId = saleId;
                    deleteSaleModal.classList.remove('hidden');
                }
            });

            // Hủy Xóa/Sửa Đơn Hàng
            document.getElementById('cancel-delete-sale-btn').addEventListener('click', () => deleteSaleModal.classList.add('hidden'));
            document.getElementById('cancel-edit-sale-btn').addEventListener('click', () => editSaleModal.classList.add('hidden'));

            // Xác nhận xóa đơn hàng
            document.getElementById('confirm-delete-sale-btn').addEventListener('click', async () => {
                const saleId = deleteSaleModal.dataset.saleId;
                if (!saleId) return;

                try {
                    await deleteSale(saleId);
                    deleteSaleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi xóa đơn hàng:", error);
                    alert("Lỗi: " + error.message);
                }
            });
            
            // Form sửa đơn hàng (Xóa cái cũ, tạo cái mới)
            document.getElementById('edit-sale-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const feedbackEl = document.getElementById('edit-sale-feedback');
                feedbackEl.textContent = '';
                
                const saleId = document.getElementById('edit-sale-id').value;
                const originalSale = sales.find(s => s.id === saleId);

                const newSaleDetails = {
                    productId: originalSale.productId,
                    quantityToSell: Number(document.getElementById('edit-sale-quantity').value),
                    sellingPrice: Number(document.getElementById('edit-sale-price').value),
                    dateValue: document.getElementById('edit-sale-date').value
                };

                // Kiểm tra số lượng hợp lệ
                const currentStock = inventory
                    .filter(item => item.productId === originalSale.productId)
                    .reduce((sum, item) => sum + item.remainingQuantity, 0);
                const maxAllowedQuantity = currentStock + originalSale.quantitySold;

                if (newSaleDetails.quantityToSell > maxAllowedQuantity) {
                    feedbackEl.textContent = `Lỗi: Số lượng bán không thể vượt quá ${maxAllowedQuantity} (tồn kho hiện tại + số lượng hoàn lại).`;
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                    return;
                }

                const button = e.target.querySelector('button[type="submit"]');
                button.disabled = true;

                try {
                    // Thực hiện xóa đơn hàng cũ (hoàn kho)
                    await deleteSale(saleId);
                    // Tạo đơn hàng mới với thông tin đã sửa
                    await createSale(newSaleDetails);
                    
                    editSaleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi cập nhật đơn hàng:", error);
                    feedbackEl.textContent = `Lỗi: ${error.message}`;
                    feedbackEl.className = 'text-red-400 text-sm h-5';
                    // Cảnh báo: Nếu bước tạo mới thất bại, đơn hàng cũ đã bị xóa.
                    // Cần thông báo cho người dùng kiểm tra lại.
                    alert("Đã xảy ra lỗi trong quá trình cập nhật. Đơn hàng gốc đã được xóa để hoàn kho, vui lòng kiểm tra và tạo lại đơn hàng mới nếu cần.");
                } finally {
                    button.disabled = false;
                }
            });


            function initializeAppData(currentStoreId) {
                storeId = currentStoreId;
                document.getElementById('store-id-display').textContent = storeId;
                document.getElementById('store-id-display-container').classList.remove('hidden');
                
                signInAnonymously(auth).then(() => {
                    setDefaultDates(); 
                    initializeTabs();
                    initializeReportFilters();
                    
                    const monthPicker = document.getElementById('stats-month-picker');
                    const allTimeBtn = document.getElementById('stats-all-time-btn');

                    const now = new Date();
                    const currentMonthISO = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    monthPicker.value = currentMonthISO;
                    statsFilterValue = currentMonthISO; 

                    monthPicker.addEventListener('change', (e) => {
                        statsFilterValue = e.target.value;
                        updateStats();
                    });

                    allTimeBtn.addEventListener('click', () => {
                        statsFilterValue = 'all';
                        monthPicker.value = ''; 
                        updateStats();
                    });


                    // Lắng nghe thay đổi của config
                    const configRef = doc(db, `stores/${storeId}/config/business`);
                    unsubscribeConfig = onSnapshot(configRef, (doc) => {
                        if (doc.exists()) {
                            businessConfig = doc.data();
                            document.getElementById('setting-fixed-cost').value = businessConfig.fixedCost || '';
                            document.getElementById('setting-profit-margin').value = businessConfig.profitMargin || '';
                        }
                        updateStats();
                        calculateSuggestedPrice();
                    });

                    const productsQuery = query(collection(db, `stores/${storeId}/products`));
                    unsubscribeProducts = onSnapshot(productsQuery, (snapshot) => {
                        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        products.sort((a,b) => a.createdAt.seconds - b.createdAt.seconds);
                        renderAll();
                    }, (error) => console.error("Lỗi lắng nghe products:", error));

                    const inventoryQuery = query(collection(db, `stores/${storeId}/inventoryBatches`));
                    unsubscribeInventory = onSnapshot(inventoryQuery, (snapshot) => {
                        inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderAll();
                    }, (error) => console.error("Lỗi lắng nghe inventory:", error));

                    const salesQuery = query(collection(db, `stores/${storeId}/sales`));
                    unsubscribeSales = onSnapshot(salesQuery, (snapshot) => {
                        sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderAll();
                    }, (error) => console.error("Lỗi lắng nghe sales:", error));

                    loader.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    storeIdModal.classList.add('hidden');
                }).catch(err => {
                     console.error("Lỗi đăng nhập ẩn danh:", err);
                     loader.innerHTML = "Không thể kết nối tới dịch vụ xác thực. Vui lòng kiểm tra lại cấu hình Firebase và Quy tắc Bảo mật (Security Rules).";
                });
            }

            document.getElementById('use-store-id-btn').addEventListener('click', () => {
                const inputId = document.getElementById('store-id-input').value.trim();
                if (inputId) {
                    if(unsubscribeProducts) unsubscribeProducts();
                    if(unsubscribeInventory) unsubscribeInventory();
                    if(unsubscribeSales) unsubscribeSales();
                    if(unsubscribeConfig) unsubscribeConfig();
                    localStorage.setItem('piggyBankStoreId', inputId);
                    initializeAppData(inputId);
                }
            });

            const savedStoreId = localStorage.getItem('piggyBankStoreId');
            if (savedStoreId) {
                initializeAppData(savedStoreId);
            } else {
                storeIdModal.classList.remove('hidden');
            }
        }
    });
    </script>

</body>
</html>
